# BV-RAG æ·±åº¦æŠ€æœ¯åˆ†æï¼šT103 & T104

> **ç›®æ ‡**ï¼šå®šä½æ¯é“é¢˜çš„å¤±è´¥é“¾è·¯ï¼Œç»™å‡ºå¯ç›´æ¥æ‰§è¡Œçš„æ£€æŸ¥æ­¥éª¤ã€ä¿®å¤æ–¹æ¡ˆå’Œ Prompt æ”¹è¿›

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šT103 â€” æ•‘ç”Ÿç­é™è½è®¾å¤‡ï¼ˆfree-fall é…ç½®ï¼‰

## 1. æ•…éšœç°è±¡

| ç‰ˆæœ¬ | ç³»ç»Ÿå›ç­” | æ­£ç¡®ç­”æ¡ˆ | åå·® |
|------|---------|---------|------|
| v1 | "éœ€è¦è‡³å°‘ä¸€èˆ·é…å¤‡é™è½è®¾å¤‡"ï¼Œä½†æ–¹æ¡ˆä¸€è¯´ free-fall æ—¶"æ— éœ€é™è½è®¾å¤‡" | è‡³å°‘ä¸€èˆ·éœ€ davit | æ–¹æ¡ˆä¸€ç»“è®ºåäº† |
| v2 | **"æ˜¯çš„ï¼Œéƒ½ä¸éœ€è¦ davit"** | è‡³å°‘ä¸€èˆ·éœ€ davit | å®Œå…¨ç›¸åï¼Œä¸”æ›´åŠ è‚¯å®š |

ä¸¤ä¸ªç‰ˆæœ¬ä¸€è‡´çŠ¯é”™ï¼Œv2 æ›´ä¸¥é‡ã€‚è¿™æ˜¯ä¸€ä¸ª**å®‰å…¨å…³é”®é¡¹**â€”â€”é”™è¯¯çš„é…ç½®ä¼šå¯¼è‡´å—ä¼¤èˆ¹å‘˜æ— æ³•å®‰å…¨æ’¤ç¦»ã€‚

---

## 2. æ•…éšœé“¾è·¯é€å±‚è§£å‰–

### 2.1 Layer 1 â€” æ£€ç´¢å±‚ï¼ˆRetrievalï¼‰

**æ—¥å¿—å®è¯**ï¼ˆæ¥è‡ªç±»ä¼¼æŸ¥è¯¢ "è´§èˆ¹é…å¤‡äº†è‡ªç”±æŠ›è½æ•‘ç”Ÿè‰‡â€¦æ•‘ç”Ÿç­æ˜¯å¦éœ€è¦é™è½è£…ç½®"ï¼‰ï¼š

å‘é‡æ£€ç´¢è¿”å› 30 æ¡ â†’ RRF èåˆå 15 æ¡ï¼Œé€å…¥ LLM çš„ Chunk æ¸…å•å¦‚ä¸‹ï¼š

| åºå· | Chunk æ ‡é¢˜ | æ¥æº | Score | æ˜¯å¦å«ç­”æ¡ˆï¼Ÿ |
|------|-----------|------|-------|------------|
| 1 | 4.1.4 Davit-launched liferafts | LSA Code IV | 0.666 | âŒ è®¾å¤‡è§„æ ¼ï¼Œéé…ç½®è¦æ±‚ |
| 2 | 4.2.8 Davit-launched inflatable liferafts | LSA Code IV | 0.663 | âŒ è®¾å¤‡è§„æ ¼ |
| 3 | 4.3.7 Davit-launched rigid liferafts | LSA Code IV | 0.630 | âŒ è®¾å¤‡è§„æ ¼ |
| 4 | 6.1.3 Float-free launching | LSA Code VI | 0.628 | âŒ é‡Šæ”¾æœºåˆ¶ï¼Œéé…ç½®è¦æ±‚ |
| 5 | 10.6 Survival craft launching arrangements | MODU Code 10 | 0.621 | âŒ æµ·ä¸Šé’»äº•å¹³å°ï¼Œéè´§èˆ¹ |
| 6 | 6.1.5 Liferaft launching appliances | LSA Code VI | 0.619 | âŒ åŠè½¦æŠ€æœ¯è§„æ ¼ |
| 7 | 6.1.4 Launching appliances for free-fall lifeboats | LSA Code VI | 0.619 | âŒ free-fall è®¾å¤‡è§„æ ¼ |
| 8 | 6.1.1 General requirements | LSA Code VI | 0.600 | âŒ é€šç”¨é™è½è®¾å¤‡è¦æ±‚ |
| 9 | 6.2.3 Inflatable liferafts (MES) | LSA Code VI | 0.595 | âŒ æµ·ä¸Šæ’¤ç¦»ç³»ç»Ÿ |
| 10 | 6.1.1 General requirements (cont.) | LSA Code VI | 0.594 | âŒ é™åŠ›è¯•éªŒè¦æ±‚ |
| 11 | Regulation 22 - Rigid liferafts | SFV Convention | 0.592 | âŒ æ¸”èˆ¹æ³•è§„ |
| 12 | 10.7 Survival craft launching | 2009 MODU Code | 0.591 | âŒ æµ·ä¸Šé’»äº•å¹³å° |
| 13 | 6.1.7 Fast rescue boats | LSA Code VI | 0.590 | âŒ å¿«é€Ÿæ•‘åŠ©è‰‡ |
| 14 | Safety Equipment Certificate form | MSC.338(91) | 0.589 | âŒ è¯ä¹¦æ ¼å¼ |
| 15 | Nuclear Cargo Ship Safety Certificate | MSC.338(91) | 0.585 | âŒ æ ¸åŠ¨åŠ›èˆ¹è¯ä¹¦ |

**è‡´å‘½ç¼ºå¤±**ï¼š

| ç¼ºå¤±çš„å…³é”®æ¡æ–‡ | å†…å®¹æ‘˜è¦ | ä¸ºä»€ä¹ˆå¿…é¡»æœ‰å®ƒï¼Ÿ |
|---------------|---------|---------------|
| âŒ **SOLAS III/31.1.4** åŸæ–‡ | "cargo ships of 85m+ shall be provided with liferafts served by launching appliances, equally distributed on each side" | **è¿™æ˜¯è§„å®š"å“ªäº›èˆ¹éœ€è¦ davit"çš„é…ç½®è¦æ±‚æ¡æ¬¾** |
| âŒ **SOLAS III/31.1.2** | å…³äº free-fall lifeboat ä¸å…¶ä»–æ•‘ç”Ÿè®¾å¤‡çš„äº’è¡¥å…³ç³» | æ˜ç¡® free-fall ä¸å…é™¤ davit è¦æ±‚ |
| âŒ **SOLAS III/31.1.1** | è´§èˆ¹æ•‘ç”Ÿè‰‡ç­æ€»ä½“é…ç½®è¦æ±‚ | ä¸Šä¸‹æ–‡æ¡†æ¶ |
| âŒ **MSC.1/Circ.1206** | free-fall lifeboat é…ç½®çš„ç»Ÿä¸€è§£é‡Š | è¡Œä¸šæƒå¨è§£è¯» |

**è¯Šæ–­ç»“è®º**ï¼šæ£€ç´¢è¿”å›çš„å…¨éƒ¨æ˜¯ LSA Code çš„**è®¾å¤‡æŠ€æœ¯è§„æ ¼**ï¼ˆ"davit-launched liferaft åº”æ»¡è¶³ä»€ä¹ˆæŠ€æœ¯æ ‡å‡†"ï¼‰ï¼Œè€Œé SOLAS Chapter III çš„**èˆ¹èˆ¶é…ç½®è¦æ±‚**ï¼ˆ"å“ªäº›èˆ¹å¿…é¡»é… davit"ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**è¯­ä¹‰æ¼‚ç§»**â€”â€”Embedding æ¨¡å‹å°† "davit" + "liferaft" çš„é«˜é¢‘å…±ç°è¯æ•æ‰åˆ°äº†ï¼Œä½†æ²¡æœ‰åŒºåˆ†"è®¾å¤‡è§„æ ¼"vs"é…ç½®ä¹‰åŠ¡"ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æ³•è§„è¯­ä¹‰å±‚ã€‚

**BM25 è¿”å› 0 æ¡**ï¼šæ··åˆæ£€ç´¢çš„ç²¾ç¡®åŒ¹é…é€šé“å®Œå…¨å¤±æ•ˆï¼Œæœªèƒ½è¡¥æ•‘å‘é‡æ£€ç´¢çš„è¯­ä¹‰æ¼‚ç§»ã€‚

**Graph Expansion æ— æ–°å¢**ï¼šæ‰¾åˆ° 4 ä¸ªå…³è”æ–‡æ¡£ IDï¼ˆMODU Code ç›¸å…³ï¼‰ï¼Œä½†ä¸ SOLAS III/31 æ— å…³è”è¾¹ï¼Œæœªèƒ½æ‰©å±•åˆ°æ­£ç¡®æ¡æ–‡ã€‚

### 2.2 Layer 2 â€” å®åŠ¡çŸ¥è¯†åº“ï¼ˆDomain Knowledge Injectionï¼‰

æ—¥å¿—ä¸­å®åŠ¡çŸ¥è¯†åº“æ³¨å…¥çš„**å®Œæ•´å†…å®¹**ï¼š

```
## éªŒèˆ¹å®åŠ¡å‚è€ƒï¼ˆæ¥è‡ªèµ„æ·±éªŒèˆ¹å¸ˆç»éªŒï¼‰
### è´§èˆ¹æ•‘ç”Ÿç­é™è½è®¾å¤‡é…ç½®
**é€‚ç”¨æ³•è§„**: SOLAS III/31, SOLAS III/31.1.4, SOLAS III/16, LSA Code 6.1

**æ­£ç¡®ç†è§£**: â‰¥85m è´§èˆ¹çš„æ ‡å‡†é…ç½®æ˜¯ï¼šä¸€èˆ·é… davit + davit-launched liferaftï¼Œ
å¦ä¸€èˆ·é… throw-overboard liferaftï¼ˆå¸¦é™æ°´å‹åŠ›é‡Šæ”¾ï¼‰ã€‚
ä¸¤èˆ·æ•‘ç”Ÿç­æ€»å®¹é‡éœ€æ»¡è¶³å…¨èˆ¹äººå‘˜100%ã€‚

**å¸¸è§è¯¯è§£**: çœ‹åˆ° SOLAS III/31.1.4 è¯´ 'on each side' å°±è®¤ä¸º
ä¸¤èˆ·éƒ½éœ€è¦ davit-launched liferaftã€‚
å®é™…ä¸Šåªè¦ä¸€èˆ·æœ‰ davit å³å¯ï¼Œå¦ä¸€èˆ·å¯ä»¥æ˜¯ throw-overboard æŠ›æŠ•å¼ã€‚

**å…¸å‹é…ç½®**:
- æœ€å¸¸è§é…ç½®ï¼šèˆ¹å°¾ free-fall lifeboatï¼ˆå®¹çº³100%äººå‘˜ï¼‰+ ä¸¤èˆ· throw-overboard liferafts  â† âš ï¸ è¿™æ¡æ˜¯é”™çš„
- æ—  free-fall é…ç½®ï¼šä¸€èˆ· davit + davit-launched liferaftï¼Œå¦ä¸€èˆ· throw-overb[æˆªæ–­]
```

**ä¸‰ä¸ªè‡´å‘½é—®é¢˜**ï¼š

| # | é—®é¢˜ | å½±å“ |
|---|------|------|
| **P1** | "æœ€å¸¸è§é…ç½®ï¼šfree-fall + ä¸¤èˆ· throw-overboard" **å†…å®¹é”™è¯¯** | éªŒèˆ¹å¸ˆæ˜ç¡®è¯´ free-fall æ—¶ä»éœ€ä¸€èˆ· davit |
| **P2** | "æ­£ç¡®ç†è§£"éƒ¨åˆ†åªè¦†ç›–äº†"æ—  free-fall"çš„åœºæ™¯ï¼Œ**é—æ¼äº† free-fall åœºæ™¯çš„æ­£ç¡®è¦æ±‚** | LLM æ— æ³•æ¨æ–­å‡º free-fall æ—¶çš„æ­£ç¡®é…ç½® |
| **P3** | è§¦å‘æ¡ä»¶è¿‡å®½â€”â€”åªè¦ query ä¸­å‡ºç° "cargo ship" å°±æ³¨å…¥ | è¢«æ³¨å…¥äº†åŒ–å­¦å“èˆ¹å¼ºåº¦è¯•éªŒã€å±é™©å“é€šé£ã€ä¸»æœºåœæœºç­‰å®Œå…¨æ— å…³çš„æŸ¥è¯¢ |

### 2.3 Layer 3 â€” LLM æ¨ç†å±‚ï¼ˆGenerationï¼‰

LLM é¢å¯¹çš„ä¸Šä¸‹æ–‡æ‹¼è£…ï¼š
- 15 ä¸ª LSA Code è®¾å¤‡è§„æ ¼ Chunkï¼ˆå‡ä¸å«é…ç½®ä¹‰åŠ¡ä¿¡æ¯ï¼‰
- 1 æ¡å®åŠ¡çŸ¥è¯†åº“æ¡ç›®ï¼ˆæ˜ç¡®è¯´ "free-fall + ä¸¤èˆ· throw-overboard"ï¼‰

åœ¨è¿™ç§ context ä¸‹ï¼ŒLLM åšå‡º"éƒ½ä¸éœ€è¦ davit"çš„ç»“è®ºæ˜¯**åˆä¹å…¶æ¨ç†é€»è¾‘çš„**â€”â€”å®ƒå¿ å®åœ°éµå¾ªäº†è¢«æ³¨å…¥çš„ domain knowledgeã€‚é—®é¢˜ä¸åœ¨ LLM æ¨ç†èƒ½åŠ›ï¼Œè€Œåœ¨äº**å–‚ç»™å®ƒçš„ææ–™å°±æ˜¯é”™çš„**ã€‚

---

## 3. T103 æ£€æŸ¥æ–¹æ¡ˆ

### æ£€æŸ¥ Aï¼šå‘é‡åº“ä¸­ SOLAS III/31 æ˜¯å¦å­˜åœ¨

```bash
# åœ¨ Qdrant ä¸­æŸ¥æ‰¾ SOLAS III/31 ç›¸å…³æ–‡æ¡£
curl -X POST "https://<qdrant-host>/collections/imo_regulations/points/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "filter": {
      "should": [
        {"key": "title", "match": {"text": "Regulation 31"}},
        {"key": "reg_num", "match": {"text": "SOLAS III/31"}},
        {"key": "source", "match": {"text": "Chapter III"}}
      ]
    },
    "limit": 20,
    "with_payload": true
  }'
```

**é¢„æœŸ**ï¼šåº”è‡³å°‘æ‰¾åˆ° SOLAS III/31.1.1 ~ 31.1.4 çš„ Chunkã€‚å¦‚æœæ‰¾ä¸åˆ° â†’ è¯´æ˜åˆ‡ç‰‡æ—¶é—æ¼æˆ–æœªå…¥åº“ã€‚

### æ£€æŸ¥ Bï¼šEmbedding ç›¸ä¼¼åº¦éªŒè¯

```python
import openai

# 1. ç”¨æˆ·æŸ¥è¯¢çš„ embedding
q = "cargo ship with free-fall lifeboat, do liferafts on each side need davit launching appliance?"
q_emb = openai.embeddings.create(model="text-embedding-3-small", input=q).data[0].embedding

# 2. å¯¹æ¯”ä¸¤ç±»æ–‡æ¡£çš„ embedding è·ç¦»
doc_correct = "SOLAS III/31.1.4: cargo ships of 85 metres in length and upwards shall carry liferafts served by launching appliances equally distributed on each side of the ship"
doc_retrieved = "LSA Code 4.1.4.1: a liferaft for use with an approved launching appliance shall when loaded with its full complement of persons and equipment be capable of withstanding..."

from numpy import dot
from numpy.linalg import norm

def cosine(a, b): return dot(a, b) / (norm(a) * norm(b))

emb_correct = openai.embeddings.create(model="text-embedding-3-small", input=doc_correct).data[0].embedding
emb_retrieved = openai.embeddings.create(model="text-embedding-3-small", input=doc_retrieved).data[0].embedding

print(f"Query â†” SOLAS III/31.1.4 (æ­£ç¡®): {cosine(q_emb, emb_correct):.4f}")
print(f"Query â†” LSA Code 4.1.4 (è¢«æ£€ç´¢): {cosine(q_emb, emb_retrieved):.4f}")
```

**é¢„æœŸ**ï¼šå¦‚æœ LSA Code åˆ†æ•°æ›´é«˜ â†’ è¯å® Embedding æ¨¡å‹æ— æ³•åŒºåˆ†"è®¾å¤‡è§„æ ¼"vs"é…ç½®ä¹‰åŠ¡"çš„è¯­ä¹‰å·®å¼‚ï¼Œéœ€è¦ä¸“é—¨å¤„ç†ã€‚

### æ£€æŸ¥ Cï¼šBM25 ç´¢å¼•çŠ¶æ€

```python
# æ£€æŸ¥ BM25 ç´¢å¼•æ˜¯å¦æ­£å¸¸è¿è¡Œ
from retrieval.hybrid_retriever import HybridRetriever
retriever = HybridRetriever()

# ç›´æ¥æµ‹è¯• BM25
results = retriever.bm25_search("SOLAS III/31.1.4 cargo ship liferaft davit launching appliance")
print(f"BM25 results: {len(results)}")
for r in results[:5]:
    print(f"  {r.score:.4f} | {r.title}")
```

**é¢„æœŸ**ï¼šå¦‚æœè¿”å› 0 â†’ BM25 ç´¢å¼•æœ‰ç»“æ„æ€§é—®é¢˜ï¼ˆæœªæ„å»ºã€åˆ†è¯é”™è¯¯ã€æˆ–ç´¢å¼•ä¸ºç©ºï¼‰ã€‚

### æ£€æŸ¥ Dï¼šå®åŠ¡çŸ¥è¯†åº“è§¦å‘æ¡ä»¶

```python
# æ£€æŸ¥ domain knowledge çš„åŒ¹é…é€»è¾‘
from generation.domain_knowledge import DomainKnowledgeStore
store = DomainKnowledgeStore()

# æµ‹è¯•ä¸åŒæŸ¥è¯¢æ˜¯å¦éƒ½è§¦å‘åŒä¸€æ¡ç›®
test_queries = [
    "è´§èˆ¹æ•‘ç”Ÿç­ davit è¦æ±‚",           # åº”è¯¥åŒ¹é…
    "åŒ–å­¦å“èˆ¹è´§èˆ±å¼ºåº¦è¯•éªŒ",              # ä¸åº”è¯¥åŒ¹é…
    "è´§èˆ¹å±é™©å“é€šé£è¦æ±‚",                # ä¸åº”è¯¥åŒ¹é…
    "ä¸»æœºåœæœºæ¡ä»¶",                     # ä¸åº”è¯¥åŒ¹é…
]
for q in test_queries:
    matches = store.match(q)
    print(f"Query: {q}")
    for m in matches:
        print(f"  â†’ {m.title} (score: {m.score})")
```

---

## 4. T103 ä¿®å¤æ–¹æ¡ˆ

### Fix 1ï¼šä¿®æ­£å®åŠ¡çŸ¥è¯†åº“æ¡ç›®ï¼ˆç´§æ€¥ï¼Œç«‹å³æ‰§è¡Œï¼‰

**åˆ é™¤ç°æœ‰é”™è¯¯æ¡ç›®ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä¿®æ­£ç‰ˆ**ï¼š

```yaml
# domain_knowledge/liferaft_davit_cargo_ship.yaml
id: dk_liferaft_davit_001
title: "è´§èˆ¹æ•‘ç”Ÿç­é™è½è®¾å¤‡é…ç½®ï¼ˆå« free-fall åœºæ™¯ï¼‰"
applicable_regulations:
  - SOLAS III/31.1.4
  - SOLAS III/31.1.2
  - SOLAS III/16
  - LSA Code 6.1
trigger_conditions:
  intent: [applicability, requirement]
  keywords_all: [liferaft OR æ•‘ç”Ÿç­]           # å¿…é¡»å«æ•‘ç”Ÿç­
  keywords_any: [davit, launching appliance, é™è½, åŠè½¦, free-fall, è‡ªç”±æŠ›è½]
  ship_type: [cargo ship]
  exclude_topics: [fire, ventilation, machinery, ODME]  # é˜²æ­¢è¯¯è§¦å‘
status: reviewed_by_surveyor
reviewed_date: 2026-02-17

content: |
  ## è´§èˆ¹æ•‘ç”Ÿç­é™è½è®¾å¤‡é…ç½®

  ### æ ¸å¿ƒè§„åˆ™ [SOLAS III/31.1.4]
  â‰¥85m è´§èˆ¹ï¼Œä¸è®ºæ˜¯å¦é…å¤‡ free-fall lifeboatï¼Œå‡é¡»åœ¨è‡³å°‘ä¸€èˆ·é…å¤‡ davit-launched æ•‘ç”Ÿç­ã€‚

  ### é…ç½®æ–¹æ¡ˆ

  **æ–¹æ¡ˆA â€” æœ‰ free-fall lifeboat**:
  | è®¾å¤‡ | ä½ç½® | ç±»å‹ |
  |------|------|------|
  | Free-fall lifeboat | èˆ¹å°¾ | è‡ªç”±æŠ›è½ï¼Œ100%äººå‘˜ |
  | Davit-launched liferaft | **è‡³å°‘ä¸€èˆ·** | åŠè½¦é™æ”¾å¼ |
  | Throw-overboard liferaft | å¦ä¸€èˆ· | æŠ›æŠ•å¼ |

  **æ–¹æ¡ˆB â€” æ—  free-fall lifeboat**:
  | è®¾å¤‡ | ä½ç½® | ç±»å‹ |
  |------|------|------|
  | æ™®é€šæ•‘ç”Ÿè‰‡ | ä¸¤èˆ· | åŠè½¦é™æ”¾å¼ |
  | Davit-launched liferaft | è‡³å°‘ä¸€èˆ· | åŠè½¦é™æ”¾å¼ |
  | Throw-overboard liferaft | å¦ä¸€èˆ· | æŠ›æŠ•å¼ |

  ### å®‰å…¨é€»è¾‘
  Free-fall lifeboat æ˜¯é«˜å†²å‡»åŠ›ç´§æ€¥æ’¤ç¦»æ–¹å¼ï¼Œä¸é€‚ç”¨äºå—ä¼¤/è¡ŒåŠ¨ä¸ä¾¿èˆ¹å‘˜ã€‚
  æ³•è§„å¼ºåˆ¶è¦æ±‚ä¿ç•™ davit ä½œä¸ºç¼“æ…¢ã€å¹³ç¨³çš„æ›¿ä»£æ’¤ç¦»æ‰‹æ®µã€‚

  ### âš ï¸ å¸¸è§é”™è¯¯
  è®¤ä¸º"æœ‰ free-fall lifeboat å°±ä¸éœ€è¦ä»»ä½• davit"â€”â€”è¿™æ˜¯é”™è¯¯çš„ã€‚
  SOLAS III/31.1.4 çš„ davit è¦æ±‚ä¸å› é…å¤‡ free-fall lifeboat è€Œè±å…ã€‚
```

### Fix 2ï¼šå‘é‡åº“è¡¥å…… SOLAS III/31 åŸæ–‡

```python
# ç¡®è®¤ SOLAS III/31 çš„ Chunk å­˜åœ¨ï¼›è‹¥ç¼ºå¤±ï¼Œæ‰‹åŠ¨å…¥åº“
from retrieval.vector_store import VectorStore
store = VectorStore()

# å…³é”®æ¡æ–‡å¿…é¡»ä½œä¸ºç‹¬ç«‹ Chunk å…¥åº“
critical_chunks = [
    {
        "title": "SOLAS III/31.1.4 - Liferaft launching appliances on cargo ships",
        "reg_num": "SOLAS III/31",
        "collection": "convention",
        "text": """Regulation 31.1.4: In addition to complying with the requirements of
        paragraphs 31.1.1 and 31.1.2, cargo ships of 85 metres in length and upwards
        shall carry liferafts served by launching appliances, equally distributed
        on each side of the ship. [åŸæ–‡ä» imorules.com è·å–]""",
        "source": "SOLAS Chapter III - Life-Saving Appliances and Arrangements",
        "url": "https://www.imorules.com/GUID-xxx"  # å¡«å…¥å®é™… URL
    },
    {
        "title": "SOLAS III/31.1.2 - Cargo ship survival craft arrangements",
        "reg_num": "SOLAS III/31",
        "collection": "convention",
        "text": """Regulation 31.1.2: [å« free-fall lifeboat é…ç½®ä¸å…¶ä»–æ•‘ç”Ÿè®¾å¤‡
        äº’è¡¥å…³ç³»çš„æ¡æ–‡åŸæ–‡]""",
        "source": "SOLAS Chapter III - Life-Saving Appliances and Arrangements",
        "url": "https://www.imorules.com/GUID-xxx"
    }
]

for chunk in critical_chunks:
    store.upsert(chunk)
```

### Fix 3ï¼šGraph Expansion è¡¥å……å…³è”è¾¹

```python
# åœ¨çŸ¥è¯†å›¾è°±ä¸­æ·»åŠ  SOLAS III/31 â†” LSA Code çš„å…³è”
graph_edges = [
    ("SOLAS_III_31.1.4", "references", "LSA_Code_4.1.4"),
    ("SOLAS_III_31.1.4", "references", "LSA_Code_6.1.5"),
    ("SOLAS_III_31.1.2", "references", "LSA_Code_6.1.4"),  # free-fall
    ("SOLAS_III_31.1.4", "interpreted_by", "MSC.1_Circ.1206"),
]
```

### Fix 4ï¼šBM25 ç´¢å¼•ä¿®å¤

```bash
# é‡å»º BM25 ç´¢å¼•
python -m retrieval.build_bm25_index --source imo_regulations --force-rebuild

# éªŒè¯
python -m retrieval.test_bm25 --query "SOLAS III/31.1.4 cargo ship liferaft davit"
```

### Fix 5ï¼šReranker æ·»åŠ "é…ç½®ä¹‰åŠ¡ vs è®¾å¤‡è§„æ ¼"åŒºåˆ†

```python
# reranker åº”ä¼˜å…ˆçº§æå‡åŒ…å«é…ç½®ä¹‰åŠ¡å…³é”®è¯çš„ Chunk
CONFIGURATION_REQUIREMENT_SIGNALS = [
    "shall carry", "shall be provided with", "shall be equipped",
    "shall comply with", "are required to",
    "in addition to", "cargo ships of .* metres",
]

EQUIPMENT_SPEC_SIGNALS = [
    "shall be capable of", "shall withstand",
    "shall be of sufficient strength", "when suspended from",
    "proof load test",
]

def rerank_boost(chunk, query_intent):
    """å½“ intent=applicability æ—¶ï¼Œæå‡é…ç½®ä¹‰åŠ¡ç±» Chunkï¼Œé™ä½è®¾å¤‡è§„æ ¼ç±» Chunk"""
    if query_intent == "applicability":
        if any(re.search(pat, chunk.text, re.I) for pat in CONFIGURATION_REQUIREMENT_SIGNALS):
            chunk.score *= 1.3  # æå‡ 30%
        if any(re.search(pat, chunk.text, re.I) for pat in EQUIPMENT_SPEC_SIGNALS):
            chunk.score *= 0.7  # é™ä½ 30%
    return chunk
```

---

## 5. T103 æ”¹è¿› Prompt

### 5.1 System Prompt ä¸­å¢åŠ çš„å®‰å…¨é˜²æŠ¤æŒ‡ä»¤

åœ¨ `generation/prompts/system_prompt.txt` ä¸­è¿½åŠ ï¼š

```
## æ•‘ç”Ÿè®¾å¤‡é…ç½® â€” å¼ºåˆ¶å®‰å…¨è§„åˆ™

å½“å›ç­”æ¶‰åŠ free-fall lifeboat ä¸æ•‘ç”Ÿç­ davit é…ç½®å…³ç³»æ—¶ï¼Œä½ å¿…é¡»éµå®ˆä»¥ä¸‹äº‹å®ï¼š

**è§„åˆ™**: å³ä½¿è´§èˆ¹é…å¤‡äº† free-fall lifeboatï¼ˆå®¹çº³100%äººå‘˜ï¼‰ï¼Œæ ¹æ® SOLAS III/31.1.4ï¼Œ
â‰¥85m è´§èˆ¹ä»é¡»åœ¨è‡³å°‘ä¸€èˆ·é…å¤‡ davit-launched æ•‘ç”Ÿç­ã€‚Free-fall lifeboat ä¸å…é™¤ davit è¦æ±‚ã€‚

**åŸå› **: Free-fall æ–¹å¼æ˜¯é«˜å†²å‡»æ’¤ç¦»ï¼Œä¸é€‚ç”¨äºå—ä¼¤æˆ–è¡ŒåŠ¨ä¸ä¾¿èˆ¹å‘˜ã€‚
Davit æä¾›ç¼“æ…¢å¹³ç¨³çš„æ›¿ä»£æ’¤ç¦»æ‰‹æ®µï¼Œæ˜¯äººå‘½å®‰å…¨çš„æœ€åä¿éšœã€‚

**å¦‚æœæ£€ç´¢åˆ°çš„æ³•è§„æ–‡æœ¬ä¼¼ä¹æš—ç¤º"æœ‰ free-fall å°±ä¸éœ€è¦ davit"ï¼Œ
ä½ å¿…é¡»ä»¥ä¸Šè¿°è§„åˆ™ä¸ºå‡†ï¼Œè€Œéæ£€ç´¢æ–‡æœ¬ã€‚è¿™æ˜¯ç»éªŒèˆ¹å¸ˆç¡®è®¤çš„å¼ºåˆ¶è¦æ±‚ã€‚**
```

### 5.2 Generation Prompt æ¨¡æ¿æ”¹è¿›

ç°æœ‰ prompt æ¨¡æ¿ï¼ˆæ¨æµ‹ç»“æ„ï¼‰ï¼š

```
ä½ æ˜¯ä¸€åèµ„æ·±éªŒèˆ¹å¸ˆ...
ä»¥ä¸‹æ˜¯æ£€ç´¢åˆ°çš„æ³•è§„å†…å®¹ï¼š
{retrieved_chunks}

ä»¥ä¸‹æ˜¯å®åŠ¡çŸ¥è¯†åº“å‚è€ƒï¼š
{domain_knowledge}

ç”¨æˆ·é—®é¢˜ï¼š{query}
è¯·å›ç­”...
```

æ”¹è¿›ä¸ºï¼š

```
ä½ æ˜¯ä¸€åèµ„æ·±æµ·äº‹æ³•è§„é¡¾é—®ï¼Œå…·æœ‰ä¸°å¯Œçš„èˆ¹èˆ¶æ£€éªŒå®åŠ¡ç»éªŒã€‚

## å›ç­”åŸåˆ™

1. **æ³•è§„æ¡æ–‡ä¼˜å…ˆ**ï¼šä½ çš„å›ç­”å¿…é¡»åŸºäºæ£€ç´¢åˆ°çš„æ³•è§„åŸæ–‡ã€‚å¦‚æœåŸæ–‡è¯´ "shall"ï¼Œ
   ä¸å¯è‡ªè¡Œè§£è¯»ä¸º"å®é™…æ‰§è¡Œä¸­ä¼šæœ‰æ‰€æ”¾å®½"ã€‚æµ·äº‹æ³•è§„æ˜¯å¼ºåˆ¶æ€§æ³•å¾‹æ¡æ–‡ï¼Œ
   æ²¡æœ‰ä¸»ç®¡æœºå…³çš„æ˜ç¡®è±å…æˆ–ç»Ÿä¸€è§£é‡Šï¼Œä»»ä½• "shall" è¦æ±‚å‡ä¸å¯æ”¾å®½ã€‚

2. **åŒºåˆ†"è®¾å¤‡è§„æ ¼"ä¸"é…ç½®ä¹‰åŠ¡"**ï¼š
   - "é…ç½®ä¹‰åŠ¡"ç±»æ¡æ–‡ï¼ˆå¦‚ SOLAS III/31ï¼‰è§„å®šå“ªäº›èˆ¹å¿…é¡»é…ä»€ä¹ˆè®¾å¤‡
   - "è®¾å¤‡è§„æ ¼"ç±»æ¡æ–‡ï¼ˆå¦‚ LSA Code Chapter IV/VIï¼‰è§„å®šè®¾å¤‡æœ¬èº«çš„æŠ€æœ¯æ ‡å‡†
   - å½“ç”¨æˆ·é—®"éœ€ä¸éœ€è¦é…"æ—¶ï¼Œå¿…é¡»å¼•ç”¨"é…ç½®ä¹‰åŠ¡"ç±»æ¡æ–‡ï¼Œ
     ä¸å¯ä»…å‡­"è®¾å¤‡è§„æ ¼"æ¨æ–­é…ç½®è¦æ±‚

3. **å®‰å…¨å…³é”®é¡¹æ ‡è®°**ï¼šæ¶‰åŠäººå‘½å®‰å…¨çš„ç»“è®ºï¼ˆæ•‘ç”Ÿè®¾å¤‡ã€æ¶ˆé˜²ã€ç»“æ„å®‰å…¨ï¼‰ï¼Œ
   å¦‚æœæ£€ç´¢åˆ°çš„ææ–™ä¸å……åˆ†ï¼Œå¿…é¡»æ˜ç¡®è¯´"å»ºè®®å‘éªŒèˆ¹æœºæ„ç¡®è®¤"ï¼Œ
   ç»ä¸å¯ç»™å‡ºä¸ç¡®å®šçš„è‚¯å®šç»“è®ºã€‚

## æ£€ç´¢åˆ°çš„æ³•è§„å†…å®¹
{retrieved_chunks}

## éªŒèˆ¹å®åŠ¡å‚è€ƒï¼ˆç»éªŒèˆ¹å¸ˆå®¡æ ¸ï¼‰
{domain_knowledge}

## ç”¨æˆ·é—®é¢˜
{query}

## å›ç­”è¦æ±‚
- ç»“è®ºå…ˆè¡Œï¼Œç¬¬ä¸€å¥ç»™å‡ºæ˜ç¡®åˆ¤æ–­
- å¼•ç”¨å…·ä½“æ³•è§„ç¼–å·å’Œæ¡æ¬¾å·
- å¦‚æœæ£€ç´¢ææ–™ä¸­ç¼ºå°‘å…³é”®çš„"é…ç½®ä¹‰åŠ¡"ç±»æ¡æ–‡ï¼ˆå¦‚ SOLAS Chapter III çš„ Regulationï¼‰ï¼Œ
  åŠ¡å¿…å£°æ˜"æ£€ç´¢åˆ°çš„ææ–™ä¸»è¦æ˜¯è®¾å¤‡æŠ€æœ¯è§„æ ¼ï¼ŒæœªåŒ…å«é…ç½®è¦æ±‚çš„å…·ä½“æ¡æ–‡ï¼Œ
  å»ºè®®æŸ¥é˜… SOLAS III/31 åŸæ–‡"
- æ¶‰åŠå®‰å…¨å…³é”®é¡¹æ—¶ï¼Œå®å¯ä¿å®ˆä¹Ÿä¸å¯é—æ¼è¦æ±‚
```

---

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šT104 â€” ODME æ’æ²¹é™åˆ¶

## 1. æ•…éšœç°è±¡

| ç‰ˆæœ¬ | ç³»ç»Ÿå›ç­” | æ­£ç¡®ç­”æ¡ˆ | åå·® |
|------|---------|---------|------|
| v1 | "æ²¡æœ‰ç»å¯¹çš„æ€»æ’æ²¹é‡é™åˆ¶"ï¼›15ppmï¼›111,111 mÂ³ | 1/30,000 æ€»è£…è½½å®¹ç§¯ | é”™è¯¯å®šæ€§ç»“è®º + æ•°æ®å¼ å† ææˆ´ |
| v2 | "æ‰€æä¾›çš„æ³•è§„èµ„æ–™ä¸­å¹¶æœªåŒ…å«å…·ä½“é™å€¼"ï¼›æŒ‡å‘ Reg 34 | 1/30,000 æ€»è£…è½½å®¹ç§¯ | è¯šå®æ‰¿è®¤ä¸è¶³ï¼Œä½†ä»ç¼ºå…³é”®æ•°æ® |

---

## 2. æ•…éšœé“¾è·¯é€å±‚è§£å‰–

### 2.1 Layer 1 â€” æ£€ç´¢å±‚

**è™½ç„¶æ²¡æœ‰ T104 çš„ç›´æ¥æ—¥å¿—**ï¼Œä½†ä» v1 å’Œ v2 å›ç­”ä¸­å¯ä»¥åå‘æ¨æ–­æ£€ç´¢åˆ°çš„ Chunkï¼š

| v1/v2 å¼•ç”¨çš„æ¥æº | æ¨æ–­æ£€ç´¢åˆ°çš„ Chunk | æ˜¯å¦å«æ­£ç¡®ç­”æ¡ˆï¼Ÿ |
|-----------------|-------------------|---------------|
| MARPOL Reg 30 | MARPOL Annex I Regulation 30 (æ—§ç¼–å·) çš„æŸä¸ª Chunk | âŒ å¯èƒ½åªå«æ ‡é¢˜æˆ–æ¦‚è¿° |
| MEPC.122(52) | å…³äº Accidental Oil Outflow çš„å†³è®® | âŒ è¿™æ˜¯æº¢æ²¹äº‹æ•…è¯„ä¼°ï¼Œä¸æ˜¯æ“ä½œæ’æ”¾é™åˆ¶ |
| MEPC.108(49) | ODME è®¾å¤‡æŠ€æœ¯æŒ‡å— | âŒ è®¾å¤‡è§„æ ¼ï¼Œéæ’æ”¾å®šé‡é™å€¼ |
| 15 ppm | å¯èƒ½æ¥è‡ª MARPOL Reg 15ï¼ˆæœºèˆ±èˆ±åº•æ°´ï¼‰| âŒ è¿™æ˜¯ machinery space çš„æ ‡å‡†ï¼Œé cargo area |

**ç¼ºå¤±çš„å…³é”®æ¡æ–‡**ï¼š

| ç¼ºå¤±æ¡æ–‡ | å†…å®¹ | ä¸ºä»€ä¹ˆå…³é”®ï¼Ÿ |
|---------|------|------------|
| âŒ **MARPOL Annex I Reg 34.1** (ç°è¡Œç¼–å·) æˆ– **Reg 30** (æ—§ç¼–å·) **çš„å®šé‡æ¡æ¬¾** | "total quantity of oil discharged shall not exceed 1/30,000 of the total quantity of cargo" | **è¿™å°±æ˜¯éªŒèˆ¹å¸ˆè€ƒçš„æ ¸å¿ƒçŸ¥è¯†ç‚¹** |
| âŒ **MARPOL Annex I Reg 34.3** | "rate of discharge shall not exceed 30 litres per nautical mile" | ç¬æ—¶æ’æ”¾ç‡é™åˆ¶ |
| âŒ **MARPOL Annex I Reg 34.2** | "ship is proceeding en route; more than 50 nautical miles from nearest land" | æ’æ”¾æµ·åŸŸé™åˆ¶ |

**æ ¹å› æ¨æ–­**ï¼š

MARPOL Annex I åœ¨ 2004 å¹´ MEPC.117(52) ä¿®æ­£æ¡ˆåé‡æ–°ç¼–å·ã€‚æ—§ Regulation 30 å˜ä¸ºæ–° Regulation 34ã€‚å‘é‡åº“å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ä¹‹ä¸€ï¼š

1. **æ¡æ–‡ç¼ºå¤±**ï¼šRegulation 34ï¼ˆæˆ–æ—§ Reg 30ï¼‰çš„å®šé‡æ¡æ¬¾æ ¹æœ¬ä¸åœ¨åº“ä¸­
2. **Chunk ç²’åº¦é—®é¢˜**ï¼šRegulation 34 çš„å…¨æ–‡å¯èƒ½è¢«åˆ‡æˆäº†å¤šä¸ª Chunkï¼Œå« "1/30,000" çš„é‚£æ®µè½å…¥äº†ä½åˆ†åŒºåŸŸ
3. **è·¨ç¼–å·æ··æ·†**ï¼šæŸ¥ "Regulation 34" æ—¶æ£€ç´¢åˆ°çš„æ˜¯ Annex II çš„ Reg 34 æˆ–å…¶ä»–å…¬çº¦çš„åŒç¼–å·æ¡æ¬¾
4. **ä¸­è‹±æ–‡è¯­ä¹‰é¸¿æ²Ÿ**ï¼šä¸­æ–‡é—®"æ€»æ’æ²¹é‡"ï¼Œä½†è‹±æ–‡æ¡æ–‡ç”¨çš„æ˜¯ "total quantity of oil discharged into the sea" + "1/30,000 of the total quantity of the particular cargo"â€”â€”embedding æœªèƒ½å»ºç«‹å¯¹åº”å…³ç³»

### 2.2 Layer 2 â€” å®åŠ¡çŸ¥è¯†åº“

æ—¥å¿—æ˜¾ç¤ºï¼ŒT104 ç±»æŸ¥è¯¢**æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•å®åŠ¡çŸ¥è¯†åº“æ¡ç›®**ã€‚ODME/MARPOL æ’æ²¹é¢†åŸŸåœ¨å®åŠ¡çŸ¥è¯†åº“ä¸­å®Œå…¨ç©ºç™½ã€‚

### 2.3 Layer 3 â€” LLM æ¨ç†å±‚

v1 çš„ LLM çŠ¯äº†ä¸¤ä¸ªæ¨ç†é”™è¯¯ï¼š

| é”™è¯¯ | å…·ä½“è¡¨ç° | åˆ†æ |
|------|---------|------|
| **å¼ å† ææˆ´** | æŠŠ MEPC.122(52) çš„"æº¢æ²¹è¯„ä¼°å‚æ•°"å½“ä½œ"æ’æ²¹é™å€¼"å‘ˆç° | ä¸¤è€…çš„æ³•è§„ç›®çš„å®Œå…¨ä¸åŒï¼ˆè®¾è®¡éªŒè¯ vs æ“ä½œæ’æ”¾ï¼‰ |
| **é”™è¯¯å¦å®š** | ç»“è®ºè¯´"æ²¡æœ‰æ³•è§„è§„å®šæ¯èˆªæ¬¡æœ€å¤šæ’å‡ å¨" | ä½† Reg 34 æ˜ç¡®è§„å®šäº† 1/30,000â€”â€”è¯´æ˜ LLM åœ¨ context ä¸­æ²¡çœ‹åˆ°è¯¥æ•°æ®ï¼Œäºæ˜¯ï¼ˆé”™è¯¯åœ°ï¼‰æ¨æ–­ä¸ºä¸å­˜åœ¨ |

v2 çš„æ”¹è¿›ï¼šä¸å†åšé”™è¯¯çš„å¦å®šï¼Œè€Œæ˜¯æ‰¿è®¤æ£€ç´¢ä¸è¶³å¹¶æŒ‡å‘ Reg 34ã€‚è¿™æ˜¯æ­£ç¡®çš„ fallback è¡Œä¸ºã€‚

---

## 3. T104 æ£€æŸ¥æ–¹æ¡ˆ

### æ£€æŸ¥ Aï¼šMARPOL Annex I Regulation 34 åœ¨åº“ä¸­æ˜¯å¦å­˜åœ¨

```bash
# Qdrant æŸ¥è¯¢
curl -X POST "https://<qdrant-host>/collections/imo_regulations/points/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "filter": {
      "should": [
        {"key": "reg_num", "match": {"text": "MARPOL I/34"}},
        {"key": "reg_num", "match": {"text": "MARPOL I"}},
        {"key": "title", "match": {"text": "Regulation 34"}},
        {"key": "source", "match": {"text": "Annex I"}}
      ]
    },
    "limit": 30,
    "with_payload": ["title", "reg_num", "text", "source"]
  }'
```

### æ£€æŸ¥ Bï¼šå…¨æ–‡æœç´¢ "1/30,000" æˆ– "30000"

```bash
# åœ¨åŸå§‹æ–‡æ¡£åº“ä¸­æœç´¢å…³é”®æ•°å­—
grep -r "30.000\|30,000\|1/30\|30000\|thirty-thousandth" /data/imo_documents/marpol/

# åœ¨ Qdrant payload ä¸­æœç´¢
curl -X POST "https://<qdrant-host>/collections/imo_regulations/points/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "filter": {
      "must": [
        {"key": "text", "match": {"text": "30,000"}}
      ]
    },
    "limit": 10,
    "with_payload": ["title", "reg_num", "text"]
  }'
```

### æ£€æŸ¥ Cï¼šChunk ç²’åº¦åˆ†æ

```python
# å¦‚æœ Regulation 34 å­˜åœ¨ï¼Œæ£€æŸ¥å®ƒè¢«åˆ‡æˆäº†å‡ æ®µï¼Œä»¥åŠ 1/30,000 åœ¨å“ªæ®µ
chunks = store.get_by_reg_num("MARPOL I/34")
for i, c in enumerate(chunks):
    has_limit = "30,000" in c.text or "30 000" in c.text
    has_rate = "30 litres" in c.text or "30 l" in c.text.lower()
    print(f"Chunk {i}: {len(c.text)} chars | has_1/30000={has_limit} | has_30l/nm={has_rate}")
    print(f"  Title: {c.title}")
    print(f"  First 200 chars: {c.text[:200]}")
```

### æ£€æŸ¥ Dï¼šEmbedding è·ç¦»å¯¹æ¯”

```python
q = "æ²¹è½®ODMEæ’æ²¹æ€»æ’æ²¹é‡é™åˆ¶ä¸èƒ½è¶…è¿‡å¤šå°‘"

candidates = [
    "MARPOL Reg 34: total quantity of oil discharged shall not exceed 1/30,000 of total cargo",
    "MEPC.122(52): mean oil outflow parameter shall not exceed 0.015 for side damage",
    "MARPOL Reg 15: oil content of effluent shall not exceed 15 parts per million",
]

q_emb = get_embedding(q)
for c in candidates:
    c_emb = get_embedding(c)
    print(f"{cosine(q_emb, c_emb):.4f} | {c[:80]}")
```

---

## 4. T104 ä¿®å¤æ–¹æ¡ˆ

### Fix 1ï¼šç¡®ä¿ Regulation 34 å®šé‡æ¡æ¬¾å…¥åº“

```python
# MARPOL Annex I Regulation 34 å…³é”®æ®µè½å¿…é¡»ä½œä¸ºç‹¬ç«‹é«˜ä¼˜å…ˆçº§ Chunk å…¥åº“
critical_marpol_chunks = [
    {
        "title": "MARPOL Annex I Reg 34 - Oil discharge limits from cargo tank area of oil tankers",
        "reg_num": "MARPOL I/34",
        "collection": "convention",
        "priority": "high",          # æ ‡è®°ä¸ºé«˜ä¼˜å…ˆçº§
        "text": """Regulation 34 - Control of discharge of oil
        34.1 Subject to the provisions of regulations 4 and 6 of this Annex,
        any discharge into the sea of oil or oily mixtures from the cargo
        tank area of an oil tanker shall be prohibited except when all
        the following conditions are satisfied:
        .1 the tanker is not within a special area;
        .2 the tanker is more than 50 nautical miles from the nearest land;
        .3 the tanker is proceeding en route;
        .4 the instantaneous rate of discharge of oil content does not exceed
           30 litres per nautical mile;
        .5 the total quantity of oil discharged into the sea does not exceed
           for existing tankers 1/15,000 of the total quantity of the particular
           cargo of which the residue formed a part, and for new tankers 1/30,000
           of the total quantity of the particular cargo of which the residue
           formed a part; and
        .6 the tanker has in operation an oil discharge monitoring and control
           system and a slop tank arrangement as required by regulation 29
           of this Annex.
        [Source: MARPOL 73/78 Annex I, as amended]""",
        "source": "MARPOL Annex I - Prevention of Pollution by Oil",
        "url": "https://www.imorules.com/GUID-xxx"
    }
]

for chunk in critical_marpol_chunks:
    store.upsert(chunk)
```

### Fix 2ï¼šæ·»åŠ å®åŠ¡çŸ¥è¯†åº“æ¡ç›®

```yaml
# domain_knowledge/odme_discharge_limits.yaml
id: dk_odme_001
title: "æ²¹è½® ODME æ’æ²¹é™åˆ¶ï¼ˆMARPOL Annex I Reg 34ï¼‰"
applicable_regulations:
  - MARPOL Annex I Regulation 34
  - MARPOL Annex I Regulation 29
trigger_conditions:
  intent: [requirement, threshold, limit]
  keywords_all: [ODME OR æ’æ²¹ OR oil discharge OR æ’æ”¾]
  keywords_any: [æ²¹è½® OR tanker OR æ€»é‡ OR é™åˆ¶ OR limit]
  exclude_topics: [machinery space, bilge, æœºèˆ±]
status: reviewed_by_surveyor
reviewed_date: 2026-02-17

content: |
  ## æ²¹è½® ODME æ’æ²¹ä¸‰é‡é™åˆ¶ [MARPOL Annex I Reg 34]

  é€‚ç”¨äº 1979 å¹´åäº¤ä»˜çš„æ²¹è½®ï¼ˆ"new tanker"å®šä¹‰ï¼‰åœ¨è´§èˆ±åŒºåŸŸçš„æ“ä½œæ’æ”¾ã€‚

  ### å®šé‡é™åˆ¶

  | é™åˆ¶é¡¹ | è¦æ±‚ | 10ä¸‡DWT ç¤ºä¾‹ |
  |--------|------|-------------|
  | **æ€»æ’æ²¹é‡** | â‰¤ æ€»è£…è½½å®¹ç§¯çš„ **1/30,000** / æ¯èˆªæ¬¡ | â‰ˆ 3â€“4 mÂ³ |
  | **ç¬æ—¶æ’æ”¾ç‡** | â‰¤ **30 å‡/æµ·é‡Œ** | ODME å®æ—¶ç›‘æ§ |
  | **æ’æ”¾æµ·åŸŸ** | è·æœ€è¿‘é™†åœ° **>50 æµ·é‡Œ**ï¼Œéç‰¹æ®Šæµ·åŸŸ | èˆ¹ä½ç¡®è®¤ |

  ### âš ï¸ å¸¸è§æ··æ·†
  - 15 ppm æ˜¯**æœºèˆ±èˆ±åº•æ°´**çš„æ ‡å‡†ï¼ˆMARPOL Reg 15ï¼‰ï¼Œä¸æ˜¯è´§èˆ±åŒº ODME æ’æ”¾æ ‡å‡†
  - MEPC.122(52) çš„"æº¢æ²¹å‚æ•°"æ˜¯**èˆ¹ä½“è®¾è®¡è¯„ä¼°**ç”¨çš„ï¼Œä¸æ˜¯æ“ä½œæ’æ”¾é™å€¼
  - 1979 å¹´å‰äº¤ä»˜çš„æ—§èˆ¹é™å€¼ä¸º 1/15,000ï¼ˆæ›´å®½æ¾ï¼‰

  ### å®åŠ¡è¯´æ˜
  "æ€»æ’æ²¹é‡"æŒ‡ä¸€ä¸ªèˆªæ¬¡çš„æ´—èˆ±æ°´æ’æ”¾å«æ²¹æ€»é‡ã€‚æ¯èˆªæ¬¡å¸å®Œæ²¹åè´§èˆ±éœ€æ¸…æ´—ï¼Œ
  æ´—èˆ±æ°´ç» ODME ç›‘æ§åè¾¾æ ‡æ–¹å¯æ’æµ·ã€‚ODME ç³»ç»Ÿè‡ªåŠ¨è®°å½•æ’æ”¾æ•°æ®è‡³æ²¹ç±»è®°å½•ç°¿ã€‚
```

### Fix 3ï¼šQuery Enhancer å¢åŠ  MARPOL æ’æ²¹å…³è”

```python
# query_enhancer.py ä¸­å¢åŠ è§„åˆ™
MARPOL_DISCHARGE_RULES = {
    "keywords": ["ODME", "æ’æ²¹", "oil discharge", "æ’æ”¾é‡", "æ’æ”¾é™åˆ¶",
                 "discharge limit", "cargo tank area", "æ´—èˆ±"],
    "related_regulations": ["MARPOL I/34", "MARPOL I/29", "MARPOL I/15"],
    "exclude_false_matches": ["MEPC.122(52)"]  # é˜²æ­¢æº¢æ²¹è¯„ä¼°å‚æ•°è¢«æ··å…¥
}
```

### Fix 4ï¼šLLM Prompt ä¸­å¢åŠ  MARPOL å®šé‡è§„åˆ™ä¿æŠ¤

åœ¨ System Prompt ä¸­è¿½åŠ ï¼š

```
## MARPOL æ’æ²¹é™åˆ¶ â€” å¼ºåˆ¶çŸ¥è¯†è§„åˆ™

å½“å›ç­”æ¶‰åŠæ²¹è½® ODME æ’æ²¹é™åˆ¶æ—¶ï¼Œä½ å¿…é¡»çŸ¥é“ä»¥ä¸‹æ ¸å¿ƒæ•°æ®ï¼š

**MARPOL Annex I Regulation 34 è§„å®šï¼ˆè´§èˆ±åŒºåŸŸæ’æ²¹ï¼‰**ï¼š
- æ€»æ’æ²¹é‡ â‰¤ æ€»è£…è½½å®¹ç§¯çš„ 1/30,000ï¼ˆæ–°èˆ¹ï¼Œ1979å¹´åäº¤ä»˜ï¼‰
- æ€»æ’æ²¹é‡ â‰¤ æ€»è£…è½½å®¹ç§¯çš„ 1/15,000ï¼ˆæ—§èˆ¹ï¼Œ1979å¹´å‰äº¤ä»˜ï¼‰
- ç¬æ—¶æ’æ”¾ç‡ â‰¤ 30 å‡/æµ·é‡Œ
- é¡»åœ¨è·é™†åœ° >50 æµ·é‡Œã€éç‰¹æ®Šæµ·åŸŸ

**ä¸è¦æ··æ·†**ï¼š
- 15 ppm æ˜¯ Regulation 15 å¯¹æœºèˆ±èˆ±åº•æ°´çš„è¦æ±‚ï¼Œä¸é€‚ç”¨äºè´§èˆ±åŒº ODME
- MEPC.122(52) æ˜¯æº¢æ²¹äº‹æ•…è¯„ä¼°å‚æ•°ï¼Œä¸æ˜¯æ“ä½œæ’æ”¾é™å€¼

å¦‚æœæ£€ç´¢åˆ°çš„ææ–™ä¸­ä¸å« 1/30,000 æ•°æ®ï¼Œä½ ä»åº”å¼•ç”¨ä¸Šè¿°è§„åˆ™å¹¶æ ‡æ³¨æ¥æºä¸º
MARPOL Annex I Regulation 34ã€‚
```

---

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šé€šç”¨æ”¹è¿›å»ºè®®

## 1. å®åŠ¡çŸ¥è¯†åº“æ²»ç†

```
é—®é¢˜ï¼šå½“å‰æ¡ç›®æ— å®¡æ ¸çŠ¶æ€ï¼Œé”™è¯¯æ¡ç›®é•¿æœŸå­˜åœ¨ä¸”æ— æ³•è¢«å‘ç°
æ–¹æ¡ˆï¼š
  â”œâ”€â”€ æ¯æ¡çŸ¥è¯†åº“æ¡ç›®å¢åŠ  status å­—æ®µ: draft â†’ reviewed â†’ approved
  â”œâ”€â”€ å¼•å…¥"éªŒèˆ¹å¸ˆå®¡æ ¸ç­¾å"æœºåˆ¶ï¼Œæ¯æ¡å¿…é¡»è‡³å°‘ä¸€åéªŒèˆ¹å¸ˆç¡®è®¤
  â”œâ”€â”€ å®šæœŸå¤å®¡å‘¨æœŸï¼šæ¯å­£åº¦éªŒèˆ¹å¸ˆå¤å®¡å…¨éƒ¨æ¡ç›®
  â””â”€â”€ è§¦å‘æ¡ä»¶æ”¶çª„ï¼šå¢åŠ  intent + exclude_topics ç»´åº¦ï¼Œé¿å…å¹¿æ’­å¼åŒ¹é…
```

## 2. Safety-Critical Answer é˜²æŠ¤æœºåˆ¶

```python
# åœ¨ generator.py ä¸­å¢åŠ å®‰å…¨å…³é”®é¡¹åå¤„ç†
SAFETY_CRITICAL_PATTERNS = {
    "liferaft_davit": {
        "trigger": r"(free-fall|è‡ªç”±æŠ›è½).*(davit|é™è½|ä¸éœ€è¦|ä¸ç”¨|éƒ½ä¸)",
        "check": "ç»“è®ºæ˜¯å¦å¦å®šäº† davit è¦æ±‚ï¼Ÿ",
        "override": "å³ä½¿æœ‰ free-fall lifeboatï¼Œâ‰¥85m è´§èˆ¹ä»é¡»è‡³å°‘ä¸€èˆ·é… davit-launched æ•‘ç”Ÿç­ [SOLAS III/31.1.4]",
        "action": "replace_conclusion"
    },
    "odme_no_limit": {
        "trigger": r"(æ²¡æœ‰|æ— ).*(æ€»é‡|æ€»æ’æ²¹é‡|æ’æ²¹).*(é™åˆ¶|é™å€¼|è¦æ±‚)",
        "check": "ç»“è®ºæ˜¯å¦å¦å®šäº†æ’æ²¹æ€»é‡é™åˆ¶çš„å­˜åœ¨ï¼Ÿ",
        "override": "MARPOL Annex I Reg 34 è§„å®šæ¯èˆªæ¬¡æ€»æ’æ²¹é‡ â‰¤ 1/30,000 æ€»è£…è½½å®¹ç§¯",
        "action": "append_correction"
    }
}

def safety_post_check(answer: str, query: str) -> str:
    """å¯¹ LLM è¾“å‡ºåšå®‰å…¨å…³é”®é¡¹åæ ¡éªŒ"""
    for rule_id, rule in SAFETY_CRITICAL_PATTERNS.items():
        if re.search(rule["trigger"], answer):
            logger.warning(f"[SAFETY] Rule {rule_id} triggered: {rule['check']}")
            if rule["action"] == "replace_conclusion":
                answer = f"âš ï¸ å®‰å…¨ä¿®æ­£ï¼š{rule['override']}\n\n---\n\n{answer}"
            elif rule["action"] == "append_correction":
                answer += f"\n\nâš ï¸ é‡è¦è¡¥å……ï¼š{rule['override']}"
    return answer
```

## 3. å›å½’æµ‹è¯•æ¡†æ¶

```python
# tests/test_critical_answers.py
import pytest

GROUND_TRUTH = [
    {
        "id": "T103",
        "query": "90ç±³è´§èˆ¹æœ‰free-fall lifeboatï¼Œä¸¤èˆ·æ•‘ç”Ÿç­æ˜¯å¦éƒ½ä¸éœ€è¦davitï¼Ÿ",
        "must_contain": ["è‡³å°‘ä¸€èˆ·", "davit", "éœ€è¦"],
        "must_not_contain": ["éƒ½ä¸éœ€è¦", "æ— éœ€", "ä¸éœ€è¦davit"],
        "correct_answer": "è‡³å°‘ä¸€èˆ·ä»éœ€ davit-launched æ•‘ç”Ÿç­",
    },
    {
        "id": "T104",
        "query": "10ä¸‡è½½é‡å¨æ²¹è½®ODMEæ€»æ’æ²¹é‡ä¸èƒ½è¶…è¿‡å¤šå°‘ï¼Ÿ",
        "must_contain": ["1/30,000", "30", "æ€»è£…è½½å®¹ç§¯"],
        "must_not_contain": ["æ²¡æœ‰é™åˆ¶", "æ— é™åˆ¶", "æ²¡æœ‰ç»å¯¹"],
        "correct_answer": "æ€»è£…è½½å®¹ç§¯çš„ 1/30,000",
    },
]

@pytest.mark.parametrize("case", GROUND_TRUTH, ids=lambda c: c["id"])
def test_critical_answer(case, rag_pipeline):
    result = rag_pipeline.query(case["query"])
    answer = result.answer

    for phrase in case["must_contain"]:
        assert phrase in answer, f"[{case['id']}] ç¼ºå°‘å…³é”®çŸ­è¯­: '{phrase}'"

    for phrase in case["must_not_contain"]:
        assert phrase not in answer, f"[{case['id']}] åŒ…å«ç¦æ­¢çŸ­è¯­: '{phrase}'"
```

---

## é™„å½•ï¼šä¿®æ”¹æ–‡ä»¶æ¸…å•

| ä¼˜å…ˆçº§ | æ–‡ä»¶/æ¨¡å— | ä¿®æ”¹å†…å®¹ | T103 | T104 |
|--------|----------|---------|------|------|
| ğŸ”´ P0 | `domain_knowledge/liferaft_davit.yaml` | åˆ é™¤é”™è¯¯æ¡ç›®ï¼Œæ›¿æ¢ä¸ºä¿®æ­£ç‰ˆ | âœ… | |
| ğŸ”´ P0 | `domain_knowledge/odme_discharge.yaml` | æ–°å»º ODME æ’æ²¹é™åˆ¶æ¡ç›® | | âœ… |
| ğŸ”´ P0 | `generation/prompts/system_prompt.txt` | è¿½åŠ å®‰å…¨é˜²æŠ¤æŒ‡ä»¤ï¼ˆfree-fall + ODMEï¼‰ | âœ… | âœ… |
| ğŸŸ  P1 | Qdrant å‘é‡åº“ | è¡¥å…… SOLAS III/31 å’Œ MARPOL I/34 çš„ Chunk | âœ… | âœ… |
| ğŸŸ  P1 | `generation/generator.py` | æ·»åŠ  safety_post_check åæ ¡éªŒ | âœ… | âœ… |
| ğŸŸ  P1 | `generation/prompts/generation_template.txt` | æ”¹è¿› prompt æ¨¡æ¿ï¼ˆåŒºåˆ†é…ç½®ä¹‰åŠ¡ vs è®¾å¤‡è§„æ ¼ï¼‰ | âœ… | |
| ğŸŸ¡ P2 | `retrieval/query_enhancer.py` | å¢åŠ  MARPOL æ’æ²¹å…³è”è§„åˆ™ | | âœ… |
| ğŸŸ¡ P2 | `retrieval/reranker.py` | æ·»åŠ é…ç½®ä¹‰åŠ¡ vs è®¾å¤‡è§„æ ¼çš„ boost/penalize | âœ… | |
| ğŸŸ¡ P2 | `retrieval/hybrid_retriever.py` | æ’æŸ¥ BM25 ç´¢å¼•å¤±æ•ˆé—®é¢˜ | âœ… | âœ… |
| ğŸŸ¡ P2 | çŸ¥è¯†å›¾è°± | è¡¥å…… SOLAS III/31 â†” LSA Code å…³è”è¾¹ | âœ… | |
| ğŸŸ¢ P3 | `tests/test_critical_answers.py` | æ–°å»ºå›å½’æµ‹è¯•ç”¨ä¾‹ | âœ… | âœ… |
| ğŸŸ¢ P3 | Domain Knowledge æ²»ç†æµç¨‹ | å¢åŠ  status/å®¡æ ¸/å¤å®¡æœºåˆ¶ | âœ… | âœ… |
